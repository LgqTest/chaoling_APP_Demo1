# 语音功能调试指南

## 已完成的优化

### 1. 代码优化
- ✅ 增加了详细的调试日志输出
- ✅ 优化了录音格式（改为mp3，兼容性更好）
- ✅ 改进了错误提示信息
- ✅ 修复了事件处理逻辑
- ✅ 添加了录音参数配置

### 2. 配置检查
- ✅ manifest.json 已包含录音权限
- ✅ config.js 已配置API Key

---

## HBuilderX 运行配置检查

### 1. 使用自定义调试基座（重要！）

标准基座可能不支持所有功能，**必须使用自定义基座**：

**步骤：**
1. 在 HBuilderX 中，点击菜单 **运行** → **运行到手机或模拟器**
2. 选择 **制作自定义调试基座** → **Android自定义调试基座**
3. 等待基座制作完成（首次需要几分钟）
4. 制作完成后，再次点击 **运行** → **运行到Android App基座** → **选择自定义基座**

**或者使用标准基座但确保勾选：**
- 运行配置中勾选 **"使用公共测试证书"**

### 2. 检查运行配置

在运行项目前，确认以下设置：

**运行菜单 → 运行到手机或模拟器 → 运行配置：**
- ✅ 勾选 "每次运行都重新安装"
- ✅ 勾选 "使用公共测试证书"（如果使用标准基座）

### 3. 手机端权限确认

首次运行时，手机会弹出权限请求：
- ✅ **必须允许录音权限**
- ✅ **必须允许存储权限**
- ✅ **必须允许网络权限**

如果之前拒绝了，需要到手机设置中手动开启：
```
手机设置 → 应用管理 → 厨电助手 → 权限管理
```

---

## 调试步骤

### 第一步：查看控制台日志

**在 HBuilderX 中：**
1. 运行项目到手机后，打开 HBuilderX 的控制台
2. 切换到 "Console" 标签
3. 在手机上打开"语音"页面
4. 查看是否有以下日志：

**期望看到的日志：**
```
检查API Key配置: {baiduKey: "已配置", moonshotKey: "已配置"}
百度Token获取成功
语音服务已就绪
```

**如果看到错误：**
- `"百度语音Token获取失败"` → 检查网络连接和API Key配置
- `"录音权限未授予"` → 在手机设置中开启录音权限

### 第二步：测试录音按钮

在手机"语音"页面：
1. **长按**蓝色按钮"按住说话"
2. 应该看到按钮变红色，文字变成"松开结束"
3. 说话（例如："你好"）
4. 松开按钮

**控制台应该显示：**
```
开始录音按钮被点击
录音请求已发送
录音开始
停止录音按钮被点击
停止录音请求已发送
录音停止，文件路径: xxx
录音时长: xxxms
文件大小: xxxbytes
```

### 第三步：测试语音识别

如果录音成功，应该会自动进行语音识别：
1. 消息列表会显示"正在识别语音..."
2. 几秒后显示识别的文字
3. 然后AI会回复

---

## 常见问题排查

### 问题1：按钮没有反应，不显示"松开结束"

**可能原因：**
- 使用的是标准基座，不支持录音功能

**解决方案：**
→ 制作自定义调试基座（参考上面的"使用自定义调试基座"）

### 问题2：显示"录音失败"

**可能原因：**
- 没有授予录音权限
- 录音格式不支持

**解决方案：**
→ 在手机设置中授予录音权限
→ 已优化代码使用mp3格式，重新运行项目

### 问题3：显示"语音服务未就绪"

**可能原因：**
- 百度Token获取失败
- 网络连接问题

**解决方案：**
→ 检查手机是否联网
→ 查看控制台是否有"Token获取失败"的详细错误信息
→ 检查百度API Key是否正确

### 问题4：显示"语音识别失败"

**可能原因：**
- 录音文件格式问题
- 百度API调用失败

**解决方案：**
→ 已修复格式问题，使用mp3格式
→ 查看控制台具体错误信息

### 问题5：AI没有回复

**可能原因：**
- Moonshot API Key配置错误
- 网络问题

**解决方案：**
→ 检查 `common/config.js` 中的 `moonshot.apiKey`
→ 确认Key以 `sk-` 开头
→ 检查手机网络连接

---

## 测试建议

### 1. 先测试录音功能
在控制台查看是否输出录音文件信息，确认录音功能正常。

### 2. 再测试语音识别
看是否能识别出你说的话。

### 3. 最后测试AI对话
看AI是否能正常回复。

### 4. 常用测试语句
- "你好"
- "今天天气怎么样"
- "帮我开灯"
- "我想听音乐"

---

## 如果问题仍未解决

请提供以下信息：

1. **控制台日志截图**
   - 从进入语音页面开始
   - 到点击录音按钮
   - 到出现错误

2. **手机上显示的错误信息**
   - 截图手机屏幕上的错误提示

3. **运行环境信息**
   - HBuilderX 版本号
   - 是否使用自定义基座
   - 手机型号和Android版本

4. **网络状态**
   - 手机是否连接WiFi或移动网络
   - 是否使用代理或VPN

---

## 代码已优化的文件

- ✅ `pages/chat/chat.vue` - 增加了详细日志和错误处理
- ✅ `common/api.js` - 优化了API调用和格式配置
- ✅ `common/config.js` - 已配置API Key（请再次确认）

---

## 下一步

1. 在HBuilderX中重新运行项目
2. 查看控制台日志
3. 按照测试步骤逐步验证
4. 如果还有问题，提供详细的错误信息
